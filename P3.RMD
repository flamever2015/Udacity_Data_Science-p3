拍拍贷数据 探索性分析
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# 加载你最终使用的所有组件
# 在这个代码块的分析中。

# 注意，在这个代码块中，将参数 "echo" 设为假。
# This prevents the code from displaying in the knitted HTML output.这可以避免代码混入 HTML 输出显示。
# 应当在文件中，对所有代码块设为 echo=FALSE 。

library(ggplot2)
library(dplyr)
library(reshape2)


```

```{r echo=FALSE, Load_the_Data}
# 加载数据
setwd("/Users/Mac/Udacity/P3")
getwd()
LC <- read.csv("LC.csv")
LP <- read.csv("LP.csv")
LCIS <- read.csv("LCIS.csv")


```

# 单变量绘图选择
```{r echo=FALSE, Univariate_Plots}

```

# 单变量分析

### 1. 你的数据集结构是什么？
str(LC)
一般的借款期限是什么分布状况？

说明主要分布在
### 2. 你的数据集内感兴趣的主要特性有哪些？

#### 2.1 对LC数据集的观察和分析
##### 2.1.1 借款人中，男性多还是女性多？

```{r echo=FALSE}
# table(LC$性别)
ggplot(aes(x = 性别), data = LC) +
    geom_bar() +
    theme(text = element_text(family = "STHeiti"))
```
由此可见，男性比例更高。

##### 2.1.2 借款的男性和女性，更偏向于选择怎样的借款期限

```{r echo=FALSE}

summary(LC$借款期限)

ggplot(aes(x = 借款期限), data = LC) +
    geom_histogram(binwidth = 1) +
    scale_x_continuous(limits = c(1, 24)) +
    facet_wrap(~性别) +
    theme(text = element_text(family = "STHeiti"))

```
由此可见，男性和女性在选择借款期限上都较为一致，一般选择6期或者12期。

#### 2.2 对LP数据集的观察和分析
贷款的还款状态分布是怎么样的？
```{r echo=FALSE}
ggplot(aes(x = 还款状态), data = LP) +
    geom_histogram(binwidth = 0.5) +
    theme(text = element_text(family = "STHeiti"))
```
由此可见，由此可见，大部分是未还款或“已正常还款”，有一定量的“已逾期还款”，“已提前还清该标全部欠款’”和“已部分还款”比较少。

#### 2.3 对LCIS数据集的观察和分析
大部分借款人的初始评级分布是怎样的？
```{r echo=FALSE}
ggplot(aes(x = 初始评级), data = LCIS) +
    geom_bar(aes(color = 性别)) +
    theme(text = element_text(family = "STHeiti"))
```
结论：大部分借款人的初始评级为B或者C。男性的C类较多，女性的B类较多。

### 3. 你认为数据集内哪些其他特征可以帮助你探索兴趣特点？
3.1 LC数据集 - 年龄分布
3.2 总利息（应还利息和剩余利息之和）的分布情况
3.3 LCIS中 （1）历史成功借款次数和身份认证指数的关系（2）借款类型的分布
### 4. 根据数据集内已有变量，你是否创建了任何新变量？
#### 4.1 身份认证指数
不同认证，赋予不同的权重，设计一个身份认证指数来综合各种认证方式的效果。
本文提出这种思路，并给出示例，更为权重可以根据相关资料进行深入探索。
当所有方式均成功认证，则为满分为1分。
```{r echo=FALSE}
# 创建身份认证指数
LC$身份认证指数 <- NA
LC$手机认证指数 <- as.numeric(as.character(ifelse(LC$手机认证 == "成功认证", 1, 0)))
LC$户口认证指数 <- as.numeric(as.character(ifelse(LC$户口认证 == "成功认证", 1, 0)))
LC$视频认证指数 <- as.numeric(as.character(ifelse(LC$视频认证 == "成功认证", 1, 0)))
LC$学历认证指数 <- as.numeric(as.character(ifelse(LC$学历认证 == "成功认证", 1, 0)))
LC$征信认证指数 <- as.numeric(as.character(ifelse(LC$征信认证 == "成功认证", 1, 0)))
LC$淘宝认证指数 <- as.numeric(as.character(ifelse(LC$淘宝认证 == "成功认证", 1, 0)))
# 赋予各种认证方式不同的权重
LC$身份认证指数 <- (1.0 * LC$手机认证指数 + 2.0 * LC$户口认证指数 + 1.0 * LC$视频认证指数 + 2.0 * LC$学历认证指数 + 3.0 * LC$征信认证指数 + 1.0 * LC$淘宝认证指数)/(1+2+1+2+3+1)

# 绘制身份认证指数分布柱状图
ggplot(aes(x = LC$身份认证指数), data = LC) +
    geom_bar(aes(color = 性别)) +
    theme(text = element_text(family = "STHeiti"))

# 查看身份认证指数的描述性统计值
summary(LC$身份认证指数)

```

结论：平均值分布为0.13分，中位数为0.1分。结论：由此发现，大量的借款人并没有进行身份认证。应当采用用户运营手段来促使借款人认证，获取足够数据源便于分析。


### 5. 在已经探究的特性中，是否存在任何异常分布？你是否对数据进行一些操作，如清洁、调整或改变数据的形式？如果是，你为什么会这样做？



# 双变量绘图选择
```{r echo=FALSE, Bivariate_Plots}

```

# 双变量分析

### 探讨你在这部分探究中观察到的一些关系。这些感兴趣的特性与数据集内其他特性有什么区别？
针对LC数据集，探索每笔loan中的借款金额和各变量之间的关系，现在挑选了年龄、身份认证指数、
1. 借款金额与年龄的关系

```{r echo=FALSE}
# 借款金额用 以10为底的对数 来处理
ggplot(aes(x = LC$年龄, y = LC$借款金额), data = LC) +
    geom_point(alpha = 1/500, position = position_jitter(h = 0), color = 'orange') +
    coord_trans(y = "log10") +
    geom_line(stat = 'summary',fun.y = mean, linetype = 2, color = 'blue') +
    xlab("年龄") +  
    ylab("借款金额") +
    theme(text = element_text(family = "STHeiti"))

```

2. 与身份认证指数之间的关系

```{r}
# 借款金额用 以10为底的对数 来处理

```


3. 与历史成功单次借款金额的关系

定义了 历史成功单次借款金额(Historical successful single loan amount)简写为 hs1LA

```{r}
# 定义hs1LA
LC$hs1LA <- ifelse(LC$历史成功借款次数 > 0, LC$历史成功借款金额 / LC$历史成功借款次数, 0)

# hs1LA与借款金额的关系，其中借款金额依旧用 以10为底的对数 来处理
ggplot(aes(x = LC$hs1LA, y = LC$借款金额), data = LC) +
    geom_point(alpha = 1/150, position = position_jitter(h = 0), color = 'orange') +
    coord_trans(y = "log10") +
    xlim(1,15000) +
    xlab("历史成功单次借款金额") +
    ylab("借款金额") +
    theme(text = element_text(family = "STHeiti")) +
    geom_smooth(method = 'lm', color = 'red')

```

### 你是否观察到主要特性与其他特性之间的有趣关系？

### 你发现最强的关系是什么？


# 多变量绘图选择

```{r echo=FALSE, Multivariate_Plots}

```
不同的借款类型，其逾期率是否有不同？

```{r}
LCIS_APP闪电 <- subset(LCIS_clean, 借款类型 == "APP闪电")
LCIS_其他 <- subset(LCIS_clean, 借款类型 == "其他")
LCIS_应收安全标 <- subset(LCIS_clean, 借款类型 == "应收安全标")
LCIS_普通 <- subset(LCIS_clean, 借款类型 == "普通")
LCIS_电商 <- subset(LCIS_clean, 借款类型 == "电商")
```

在分析逾期率之前，发现“标当前状态”一列中有不整洁数据存在，一些数字而不是表示当期状态的字符串（如‘正常还款中’，‘逾期中’，‘已还清’，‘已债转’）。利用filter()将这些不整洁数据剔除。
```{r}
LCIS_clean <- filter(LCIS, 标当前状态 == "正常还款中" | 标当前状态 == "逾期中" | 标当前状态 == "已还清" | 标当前状态 == "已债转")
```

则不同电商平台下的逾期率
```{r}
as.data.frame(table(LCIS_APP闪电$标当前状态))
as.data.frame(table(LCIS_其他$标当前状态))
as.data.frame(table(LCIS_应收安全标$标当前状态))
as.data.frame(table(LCIS_普通$标当前状态))
as.data.frame(table(LCIS_电商$标当前状态))
```

图的绘制：
1. 随着年龄的增加，不同借款类型情况下，借款金额的变化


2. 随着年龄的增加，不同认证指数范围情况(采用cut函数 7-10课程)下，借款金额的变化


3. 热图(7-25课程)
降低运算量，只挑选部分数据
```{r}
library(GGally)
set.seed(1234)
!!! LCIS_clean_subset <- LCIS_clean[, c()]  ##此行需要完善，挑选 生成热图的列
ggpairs(LCIS_clean_subset[sample(nrow(LCIS_clean_subset),1000),])

```


# 多变量分析

###  探讨你在这部分探究中观察到的一些关系。通过观察感兴趣的特性，是否存在相互促进的特性？

### 这些特性之间是否存在有趣或惊人的联系呢？

### 选项：你是否创建过数据集的任何模型？讨论你模型的优缺点。

------

# 定稿图与总结

### 绘图一
```{r echo=FALSE, Plot_One}
# 年龄分块
# 按照以下年龄段分段
# 15-25
# 25-35
# 35-60 

LC$age_bucket <- cut(LC$年龄, c(15, 25, 35, 60))
### LC_age_clean <- subset(LC, !is.na(年龄))
# 借款金额用 以10为底的对数 来处理
ggplot(aes(x = LC$年龄, y = LC$借款金额), data = LC) +
    geom_line(aes(color = LC$age_bucket),
              stat = 'summary',
              fun.y = median) +
    coord_trans(y = "log10") +
    xlab("年龄") +
    ylab("借款金额") +
    labs(title = "不同年龄段借款金额的变化") +
    theme(text = element_text(family = "STHeiti"))

```

### 描述一
不同年龄段与其借款金额的变化关系,年龄越大，即可额度越多。


### 绘图二
```{r echo=FALSE, Plot_Two_1}

# 按照性别和年龄划分形成新数据集
LCIS_loan_by_age_gender <- LCIS %>%
    filter(!is.na(年龄) & !is.na(性别)) %>%
    group_by(年龄, 性别) %>%
    summarise(mean_loan_now = mean(借款金额),
              median_loan_now = median(借款金额),
              n = n()) %>%
    ungroup() %>%
    arrange(年龄)

# 据此绘图分析
### x1 <-  dplyr::distinct(LCIS)

ggplot(aes(x = 年龄, y = mean_loan_now),
       data = LCIS_loan_by_age_gender) +
    geom_line(aes(color = 性别)) +
    xlim(17, 56) +
    ylim(0,20000) +
    xlab("年龄") +
    ylab("借款金额平均值") +
    theme(text = element_text(family = "STHeiti"))

```

男性和女性用户借款金额的比例关系代码如下

```{r echo=FALSE, Plot_Two_1}

# 借款金额比值的探索
LCIS_loan_by_age_gender_wide <- dcast(LCIS_loan_by_age_gender,
    年龄 ~ 性别,
    value.var = "mean_loan_now")

# 比值的绘图
ggplot(aes(x = 年龄, y = 男/女),
       data = LCIS_loan_by_age_gender_wide) +
    geom_line() +
    geom_hline(yintercept = 1, alpha = 0.3, linetype = 2)

```


### 描述二
随着年龄变化，男性和女性的借款金额会有怎样的变化？
- 剔除了只有女性有的年龄段（60和65岁）数据
可得到如下结论：
1. 在15-50之间，男性要比女性用户的借款金额均值更多。
2. 男性一般为女性用户的1.5倍之间。


### 绘图三

```{r echo=FALSE, Plot_Three}

# 定义hs1LA - 已定义

# 分组

LC_loan_by_Age_Gender_Rate <- LC %>%
    filter(!is.na(年龄) & !is.na(初始评级)) %>%
    group_by(年龄, 性别, 初始评级) %>%
    summarise(mean_hs1LA_history = mean(hs1LA),
              median_hs1LA_history = median(hs1LA),
              n = n()) %>%
    ungroup() %>%
    arrange(年龄)

# 绘图
ggplot(aes(x = round(年龄/5) * 5, y = mean_hs1LA_history),
       data = LC_loan_by_Age_Gender_Rate) +
    geom_point(aes(color = 初始评级)) +
    xlim(15, 60) +
    ylim(0,20000) +
    xlab("年龄") +
    ylab("历史成功单次借款金额") +
    facet_wrap(~ 性别) +
    theme(text = element_text(family = "STHeiti"))


```

### 描述三
不同初始等级情况下，历史成功单次借款金额随着年龄有怎样的变化？

------

# 反思