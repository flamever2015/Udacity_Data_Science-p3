拍拍贷数据 探索性分析
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# 加载你最终使用的所有组件
# 在这个代码块的分析中。

# 注意，在这个代码块中，将参数 "echo" 设为假。
# This prevents the code from displaying in the knitted HTML output.这可以避免代码混入 HTML 输出显示。
# 应当在文件中，对所有代码块设为 echo=FALSE 。

library(ggplot2)
library(dplyr)
library(reshape2)
library(GGally)
library(gridExtra)
library(psych)
library(corrplot)
library(MASS)
library(splines)

```

```{r echo=FALSE, Load_the_Data}
# 加载数据

setwd("/Users/Mac/Udacity/P3")
getwd()

LC <- read.csv("LC.csv", fileEncoding='utf-8')
LP <- read.csv("LP.csv", fileEncoding='utf-8')
LCIS <- read.csv("LCIS.csv", fileEncoding='utf-8')

```

基于拍拍贷真实业务数据样本，本文探索了P2P交易中有趣的交易现象。

# 单变量绘图

#### 1. 对LC数据集的观察和分析
##### 1.0 借款金额的分布

```{r echo=FALSE}
# 绘图
ggplot(aes(x = 借款金额), data = LC) +
    geom_histogram(binwidth = 10000) +
    theme(text = element_text(family = "STHeiti"))

# 统计量
summary(LC$借款金额)
```

由此可见，大于50000的借款很少，在拍拍贷这个P2P平台中，大量交易还属于小额借款。所以重点关注金额在50000元以下的业务。

```{r echo=FALSE}

p1 <- ggplot(aes(x = 借款金额), data = subset(LC, LC$借款金额 <50000)) +
    geom_histogram(bins = 500) +
    xlab("身份认证指数") +
    theme(text = element_text(family = "STHeiti"))

p2 <- ggplot(aes(x = 借款金额), data = subset(LC, LC$借款金额 <50000)) +
    geom_histogram(bins = 500) +
    scale_x_log10() +
    xlab("身份认证指数 - 取log10") +
    theme(text = element_text(family = "STHeiti"))

p3 <- ggplot(aes(x = 借款金额), data = subset(LC, LC$借款金额 <50000)) +
    geom_histogram(bins = 500) +
    scale_x_sqrt() +
    xlab("身份认证指数 - 取平方根") +
    theme(text = element_text(family = "STHeiti"))

grid.arrange(p1, p2, p3, ncol = 1)

```

在对借款金额分布进行了对数和开方转化后，可以发现金额大部分集中1000～10000范围内。
其他观察如下。

##### 1.1 借款人中，男性多还是女性多？

```{r echo=FALSE}
# table(LC$性别)
ggplot(aes(x = 性别), data = LC) +
    geom_bar(width = 0.2) +
    theme(text = element_text(family = "STHeiti"))
```

由此可见，男性比例更高。

##### 1.2 借款的男性和女性，更偏向于选择怎样的借款期限

```{r echo=FALSE}

summary(LC$借款期限)

ggplot(aes(x = 借款期限), data = LC) +
    geom_histogram(binwidth = 1) +
    scale_x_continuous(limits = c(1, 24)) +
    facet_wrap(~性别) +
    theme(text = element_text(family = "STHeiti"))

```

由此可见，男性和女性在选择借款期限上都较为一致，一般选择6期或者12期。

#### 2. 对LP数据集的观察和分析

贷款的还款状态分布是怎么样的？

```{r echo=FALSE}
ggplot(aes(x = 还款状态), data = LP) +
    geom_histogram(binwidth = 0.5) +
    theme(text = element_text(family = "STHeiti"))
```

由此可见，大部分是未还款或“已正常还款”，有一定量的“已逾期还款”，“已提前还清该标全部欠款’”和“已部分还款”比较少。

#### 3. 对LCIS数据集的观察和分析

大部分借款人的初始评级分布是怎样的？

```{r echo=FALSE}
ggplot(aes(x = 初始评级), data = LCIS) +
    geom_bar(aes(color = 性别)) +
    theme(text = element_text(family = "STHeiti"))
```

由此可见，大部分借款人的初始评级为B或者C。男性的C类较多，女性的B类较多。

# 单变量分析

### 1. 你的数据集结构是什么？

拍拍贷数据分析项目一共提供了3个数据集。包含了成交时间从2015年1月1日到2017年1月30日的328553支信用标。

- LC表：标的特征表，每支标一条记录。共有21个字段，包括一个主键（listingid）、7个标的特征和13个成交当时的借款人信息，全部为成交当时可以获得的信息。
```{r echo=FALSE}
str(LC)
```

- LP表：标的还款计划和还款记录，每支标每期还款为一条记录。共有10个字段，包括两个主键（listingid和期数），3个还款计划字段和4个还款状态字段。

```{r echo=FALSE}
str(LP)
```

- LCIS表：所提供数据包含了该客户投资的从2015年1月1日起成交的所有标。LC部分共有21个字段，包括一个主键（listingid）、7个标的特征和13个成交当时的借款人信息，全部为成交当时可以获得的信息。IS部分有15个字段，包括截至recorddate当天标的还款状态，针对这位客户的已还和待还金额，最近的还款情况和下一期还款计划。

```{r echo=FALSE}
str(LCIS)
```


### 2. 你的数据集内感兴趣的主要特性有哪些？

结合这三个数据集，我主要关注借款金额这个变量。其他各变量的变化会如何影响借款金额。从而对借款人和投资人对行为提供参考：借款人如何改进自身的指标从而能够借到更多的钱，过去主要在哪些交易中进行了投资。

### 3. 你认为数据集内哪些其他特征可以帮助你探索兴趣特点？

初始评级、年龄、认证方式、借款利息、历史成功借款情况等因素，都可能会影响借款金额。并且这些因素对借款金额和投资行为都有很强烈的影响。

### 4. 根据数据集内已有变量，你是否创建了任何新变量？

#### 身份认证指数
不同认证，赋予不同的权重，设计一个身份认证指数来综合各种认证方式的效果。
本文提出这种思路，并给出示例，更为权重可以根据相关资料进行深入探索。
当所有方式均成功认证，则为满分为1分。

```{r echo=FALSE}

# 创建身份认证指数
LCIS$身份认证指数 <- NA
LCIS$手机认证指数 <- as.numeric(as.character(ifelse(LCIS$手机认证 == "成功认证", 1, 0)))
LCIS$户口认证指数 <- as.numeric(as.character(ifelse(LCIS$户口认证 == "成功认证", 1, 0)))
LCIS$视频认证指数 <- as.numeric(as.character(ifelse(LCIS$视频认证 == "成功认证", 1, 0)))
LCIS$学历认证指数 <- as.numeric(as.character(ifelse(LCIS$学历认证 == "成功认证", 1, 0)))
LCIS$征信认证指数 <- as.numeric(as.character(ifelse(LCIS$征信认证 == "成功认证", 1, 0)))
LCIS$淘宝认证指数 <- as.numeric(as.character(ifelse(LCIS$淘宝认证 == "成功认证", 1, 0)))

# 赋予各种认证方式不同的权重
LCIS$身份认证指数 <- (1.0 * LCIS$手机认证指数 + 2.0 * LCIS$户口认证指数 + 1.0 * LCIS$视频认证指数 + 2.0 * LCIS$学历认证指数 + 3.0 * LCIS$征信认证指数 + 1.0 * LCIS$淘宝认证指数)/(1+2+1+2+3+1)

# 查看身份认证指数的描述性统计值
summary(LCIS$身份认证指数)

# 绘制身份认证指数分布柱状图
ggplot(aes(x = LCIS$身份认证指数), data = LCIS) +
    geom_bar(aes(color = 性别)) +
    xlab("身份认证指数") +
    ylab("数量") +
    theme(text = element_text(family = "STHeiti"))

```

身份认证指数的平均值分布为0.13分，中位数为0.1分。由此发现，大量的借款人并没有进行身份认证。应当采用用户运营手段来促使借款人认证，获取足够数据源便于分析。

### 5. 在已经探究的特性中，是否存在任何异常分布？你是否对数据进行一些操作，如清洁、调整或改变数据的形式？如果是，你为什么会这样做？

对借款金额分布的探究中，进行了对数和开方的处理。结合统计量成果，可以直观感受到p2p借贷业务主要是小金额交易。由于大量交易是小金额的，所以选取小于50000元的交易，从而可以发现更多成果。

# 双变量绘图

针对LCIS数据集进行分析。通过绘制散点图矩阵，对各变量之间关系获得全局感受。
```{r echo=FALSE, Bivariate_Plots}

# 针对LCIS，分析各变量之间关系
# 选出部分重点关注的变量构成新子集 LCIS_subset 进行绘制
LCIS_subset <- LCIS[, c("借款金额", "借款期限", "借款利率", "初始评级", "借款类型", "是否首标", "年龄", "性别", "历史成功借款次数", "历史成功借款金额", "历史正常还款期数", "历史逾期还款期数")]
LCIS_subset$历史成功借款次数 <- suppressWarnings(as.numeric(as.character(LCIS_subset$历史成功借款次数)))
LCIS_subset$历史成功借款金额 <- suppressWarnings(as.numeric(as.character(LCIS_subset$历史成功借款金额)))

# 定义历史成功单次借款金额，简写为 hs1LA
LCIS_subset$hs1LA <- ifelse(LCIS_subset$历史成功借款次数 >= 1, LCIS_subset$历史成功借款金额 / LCIS_subset$历史成功借款次数, 0)

# 绘制散点图矩阵
set.seed(1234)
ggpairs(LCIS_subset[sample(nrow(LCIS_subset),5000),]) +
    theme(text = element_text(family = "STHeiti"))

```

```{r echo=FALSE}

# 借款金额和数值型变量的相关性分析
LCIS_num <- LCIS[, c("借款金额", "借款期限", "借款利率", "年龄", "我的投资金额", "历史成功借款次数", "历史成功借款金额", "历史正常还款期数", "历史逾期还款期数")]
LCIS_num$历史成功借款次数 <- suppressWarnings(as.numeric(as.character(LCIS_num$历史成功借款次数)))
LCIS_num$历史成功借款金额 <- suppressWarnings(as.numeric(as.character(LCIS_num$历史成功借款金额)))

str(LCIS_num)

# 绘制相关性矩阵
### 【corrplot参考链接】 https://github.com/taiyun/corrplot/issues/36
### 【字体设置参考链接】 https://www.zhihu.com/question/21576848
corrplot(cor(LCIS_num), method = 'number', number.digits = 1, number.cex = .75, addCoefasPercent = TRUE, family = 'STHeiti') 

```

每一笔交易中的借款或投资金额与借款人的偿还能力、消费需求和社会属性有关系。
根据散点图矩阵可发现，借款金额和年龄（社会属性）具有一定正相关性，由此可以大胆推测借款金额与身份认证指数也具有一定相关性，在之后的研究可以深入探索。
借款金额与以往的借款表现（如历史成功借款次数和金额）并没有很强的相关性。而历史借款数据之间有较强的正相关性。
“我的投资金额”是投资人对该笔交易的投资金额，可发现该值与借款利率、历史成功借款金额和期数之间为负相关。

针对LCIS数据集，探索每笔交易中的借款金额和各变量之间的关系，现在挑选了年龄、身份认证指数、与历史成功单次借款金额。

#### 1. 借款金额与年龄的关系

```{r echo=FALSE}
# 借款金额用 以10为底的对数 来处理
ggplot(aes(x = LCIS$年龄, y = LCIS$借款金额), data = LCIS) +
    geom_point(alpha = 1/100, position = position_jitter(h = 0), color = I('orange')) +
    coord_trans(y = "log10") +
    geom_line(stat = 'summary', fun.y = quantile, fun.args=list(probs=0.2), linetype = 'dashed', color = 'blue') +
    geom_line(stat = 'summary', fun.y = quantile, fun.args=list(probs=0.8), linetype = 'dashed', color = 'blue') +
    geom_line(stat = 'summary', fun.y = median, color = 'red') +
    xlab("年龄") +  
    ylab("借款金额") +
    theme(text = element_text(family = "STHeiti"))

```

由此可见，在借款金额用对数处理后，大量交易处在100000元以下，借款人年龄在55岁以下的区间内。有以下有趣发现：
- 在0-25岁之间，随着年龄的增加，借款金额是不断增加的；
- 年龄增长至*25岁后*，借款金额也就进入了平台期。借款金额均值和中位数增长很小；
- 年龄增长至*50岁后*，借款交易的积极性降低。交易量减少；
- 年龄大于60岁后，曲线出现了陡峭增加，此时样本量很少，曲线被个别数据所绑架，可以认为是异常值表现了。

#### 2. 与身份认证指数之间的关系

```{r echo=FALSE}
# 借款金额用 以10为底的对数 来处理
ggplot(aes(x = LCIS$身份认证指数, y = LCIS$借款金额), data = LCIS) +
    geom_point(alpha = 1/100, position = position_jitter(h = 0), color = I('orange')) +
    coord_trans(y = "log10") +
    geom_line(stat = 'summary', fun.y = quantile, fun.args=list(probs=0.2), linetype = 'dashed', color = 'blue') +
    geom_line(stat = 'summary', fun.y = quantile, fun.args=list(probs=0.8), linetype = 'dashed', color = 'blue') +
    geom_line(stat = 'summary', fun.y = median, color = 'red') +
    xlab("身份认证指数") +  
    ylab("借款金额") +
    theme(text = element_text(family = "STHeiti"))
```

从2015-01-01到2017-01-30的样本数据来看，用户进行身份认证的意愿并不强烈。由所得到数据来看，有以下发现：
- 随着身份认证指数的增加，借款金额是有增加的；
- 随着身份认证指数的增加，指数在(0-0.375)范围内时，借款金额的均值、0.2和0.8位数值变化并不大，但是当指数大于0.375时，*原本借款较多的人愿意借更多的钱*。

#### 未完成 - 3. 与历史成功单次借款金额的关系

定义了 历史成功单次借款金额(Historical successful single loan amount)简写为 hs1LA

```{r echo=FALSE}

# 定义hs1LA - 可以进行删选或者

#LCIS_subset <- LCIS[, c("借款金额", "借款期限", "借款利率", "初始评级", "借款类型", "是否首标", "年龄", "性别", "历史成功借款次数", "历史成功借款金额", "历史正常还款期数", "历史逾期还款期数")]
#LCIS_subset$历史成功借款次数 <- suppressWarnings(as.numeric(as.character(LCIS_subset$历史成功借款次数)))
#LCIS_subset$历史成功借款金额 <- suppressWarnings(as.numeric(as.character(LCIS_subset$历史成功借款金额)))
LCIS_subset$hs1LA <- ifelse(LCIS_subset$历史成功借款次数 >= 1, LCIS_subset$历史成功借款金额 / LCIS_subset$历史成功借款次数, 0)

# hs1LA与借款金额的关系，其中借款金额依旧用 以10为底的对数 来处理
ggplot(aes(x = LCIS_subset$hs1LA, y = LCIS_subset$借款金额), data = LCIS_subset) +
    geom_point(alpha = 1/100, position = position_jitter(h = 0), color = I('orange')) +
    coord_trans(y = "log10") +
    geom_line(stat = 'summary', fun.y = quantile, fun.args=list(probs=0.2), linetype = 'dashed', color = 'blue') +
    geom_line(stat = 'summary', fun.y = quantile, fun.args=list(probs=0.8), linetype = 'dashed', color = 'blue') +
    geom_line(stat = 'summary', fun.y = median, color = 'red') +
    xlab("历史成功单次借款金额") +  
    ylab("借款金额") +
    theme(text = element_text(family = "STHeiti"))    

```

#### 补充分析结论 - 4. 在不同初始等级条件下借款金额的变化情况
```{r echo=FALSE}
summary(LCIS$初始评级)
```

箱形图 展示
```{r echo=FALSE}
ggplot(aes(x = LCIS_subset$初始评级, y = LCIS_subset$借款金额), data = LCIS_subset) +
    geom_boxplot() +
    coord_cartesian(ylim = c(0, 25000)) +
    xlab("身初始评级") +  
    ylab("借款金额") +
    theme(text = element_text(family = "STHeiti"))
```


#### 补充分析结论 - 5. 在不同借款类型下借款金额的变化情况
```{r echo=FALSE}
summary(LCIS$借款类型)
```

箱形图 展示
```{r echo=FALSE}
ggplot(aes(x = LCIS_subset$借款类型, y = LCIS_subset$借款金额), data = LCIS_subset) +
    geom_boxplot() +
    xlab("借款类型") +  
    ylab("借款金额") +
    coord_cartesian(ylim = c(0, 300000)) +
    theme(text = element_text(family = "STHeiti"))
```



# 双变量分析
### 探讨你在这部分探究中观察到的一些关系。这些感兴趣的特性与数据集内其他特性有什么区别？

### 你是否观察到主要特性与其他特性之间的有趣关系？

### 你发现最强的关系是什么？


# 多变量绘图选择

```{r echo=FALSE, Multivariate_Plots}

```

在分析逾期率之前，发现“标当前状态”一列中有不整洁数据存在，一些数字而不是表示当期状态的字符串（如‘正常还款中’，‘逾期中’，‘已还清’，‘已债转’）。利用filter()将这些不整洁数据剔除。

```{r echo=FALSE}
LCIS_clean <- filter(LCIS, 标当前状态 == "正常还款中" | 标当前状态 == "逾期中" | 标当前状态 == "已还清" | 标当前状态 == "已债转")
```

不同的借款类型，其逾期率是否有不同？

```{r echo=FALSE}

LCIS_APP闪电 <- subset(LCIS_clean, 借款类型 == "APP闪电")
LCIS_其他 <- subset(LCIS_clean, 借款类型 == "其他")
LCIS_应收安全标 <- subset(LCIS_clean, 借款类型 == "应收安全标")
LCIS_普通 <- subset(LCIS_clean, 借款类型 == "普通")
LCIS_电商 <- subset(LCIS_clean, 借款类型 == "电商")
```

则不同电商平台下的逾期率

```{r echo=FALSE}
as.data.frame(table(LCIS_APP闪电$标当前状态))
as.data.frame(table(LCIS_其他$标当前状态))
as.data.frame(table(LCIS_应收安全标$标当前状态))
as.data.frame(table(LCIS_普通$标当前状态))
as.data.frame(table(LCIS_电商$标当前状态))
```

图的绘制：

#### 1. 随着年龄的增加，不同借款类型情况下，借款金额的变化


#### 2. 随着年龄的增加，不同认证指数范围情况(采用cut函数 7-10课程)下，借款金额的变化


# 多变量分析

### 探讨你在这部分探究中观察到的一些关系。通过观察感兴趣的特性，是否存在相互促进的特性？

### 这些特性之间是否存在有趣或惊人的联系呢？

### 选项：你是否创建过数据集的任何模型？讨论你模型的优缺点。

------

# 定稿图与总结

### 绘图一
```{r echo=FALSE, Plot_One}

# 年龄分块
# 按照以下年龄段分段
# 15-25
# 25-35
# 35-60 

LC$age_bucket <- cut(LC$年龄, c(15, 25, 35, 60))
### LC_age_clean <- subset(LC, !is.na(年龄))
# 借款金额用 以10为底的对数 来处理
ggplot(aes(x = LC$年龄, y = LC$借款金额), data = LC) +
    geom_line(aes(color = LC$age_bucket),
              stat = 'summary',
              fun.y = median) +
    coord_trans(y = "log10") +
    xlab("年龄") +
    ylab("借款金额") +
    labs(title = "不同年龄段借款金额的变化") +
    theme(text = element_text(family = "STHeiti"))

```

### 描述一

不同年龄段与其借款金额的变化关系,年龄越大，即可额度越多。


### 绘图二
```{r echo=FALSE, Plot_Two_1}

# 按照性别和年龄划分形成新数据集
LCIS_loan_by_age_gender <- LCIS %>%
    filter(!is.na(年龄) & !is.na(性别)) %>%
    group_by(年龄, 性别) %>%
    summarise(mean_loan_now = mean(借款金额),
              median_loan_now = median(借款金额),
              n = n()) %>%
    ungroup() %>%
    arrange(年龄)

# 据此绘图分析
### x1 <-  dplyr::distinct(LCIS)

ggplot(aes(x = 年龄, y = mean_loan_now),
       data = LCIS_loan_by_age_gender) +
    geom_line(aes(color = 性别)) +
    xlim(17, 56) +
    ylim(0,20000) +
    xlab("年龄") +
    ylab("借款金额平均值") +
    theme(text = element_text(family = "STHeiti"))

```

男性和女性用户借款金额的比例关系

```{r echo=FALSE, Plot_Two_2}

# 借款金额比值的探索
LCIS_loan_by_age_gender_wide <- dcast(LCIS_loan_by_age_gender,
    年龄 ~ 性别,
    value.var = "mean_loan_now")

# 比值的绘图
ggplot(aes(x = 年龄, y = 男/女),
       data = LCIS_loan_by_age_gender_wide) +
    geom_line() +
    geom_hline(yintercept = 1, alpha = 0.3, linetype = 2)

```


### 描述二

随着年龄变化，男性和女性的借款金额会有怎样的变化？
- 剔除了只有女性有的年龄段（60和65岁）数据
可得到如下结论：
1. 在15-50之间，男性要比女性用户的借款金额均值更多。
2. 男性一般为女性用户的1.5倍之间。


### 绘图三

```{r echo=FALSE, Plot_Three}

# 定义hs1LA - 已定义

LC$hs1LA <- ifelse(LC$历史成功借款次数 > 0, LC$历史成功借款金额 / LC$历史成功借款次数, 0)

# 分组

LC_loan_by_Age_Gender_Rate <- LC %>%
    filter(!is.na(年龄) & !is.na(初始评级)) %>%
    group_by(年龄, 性别, 初始评级) %>%
    summarise(mean_hs1LA_history = mean(hs1LA),
              median_hs1LA_history = median(hs1LA),
              n = n()) %>%
    ungroup() %>%
    arrange(年龄)

# 绘图
ggplot(aes(x = round(年龄/5) * 5, y = mean_hs1LA_history),
       data = LC_loan_by_Age_Gender_Rate) +
    geom_point(aes(color = 初始评级)) +
    xlim(15, 60) +
    ylim(0,20000) +
    xlab("年龄") +
    ylab("历史成功单次借款金额") +
    facet_wrap(~ 性别) +
    theme(text = element_text(family = "STHeiti"))


```

### 描述三
不同初始等级情况下，历史成功单次借款金额随着年龄有怎样的变化？

------

# 反思